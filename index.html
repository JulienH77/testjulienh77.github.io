<!DOCTYPE html>
<html>
<head>
    <title>Animation des trajets avec L.Motion</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.motion/dist/leaflet.motion.min.js"></script>
    <style>
        html, body, #map { width: 100%; height: 100%; margin: 0px; padding: 0px; }
        button { position: absolute; z-index: 1000; top: 10px; left: 10px; }
    </style>
</head>
<body>
    <div id="map"></div>
    <button id="startAnimation">Démarrer l'animation</button>
    <script>
        // Initialisation de la carte
        const map = L.map("map").setView([48.8566, 2.3522], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Fonction pour zoomer sur un trajet
        function fitBoundsForTrajet(latlngs) {
            const bounds = L.latLngBounds(latlngs);
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        // Chargement du GeoJSON
        fetch('TRAJETS_ALL_vacances_wgs.geojson')
            .then(response => response.json())
            .then(data => {
                // Trie les features par ordre de "id"
                const sortedFeatures = data.features.sort((a, b) => a.properties.id - b.properties.id);

                // Crée une séquence d'animations
                const seqGroup = L.motion.seq([]);

                // Pour chaque feature, ajoute une animation à la séquence
                sortedFeatures.forEach((feature, index) => {
                    if (feature.geometry.type === 'MultiLineString') {
                        const coordinates = feature.geometry.coordinates;
                        const trajet = feature.properties.trajet;
                        let color, iconHtml, duration = 12000; // 12 secondes par défaut

                        // Définit la couleur et l'icône selon le type de trajet
                        switch (trajet) {
                            case 'avion':
                                color = 'red';
                                iconHtml = "<i class='fa fa-plane fa-2x' aria-hidden='true'></i>";
                                break;
                            case 'train':
                                color = 'green';
                                iconHtml = "<i class='fa fa-train fa-2x' aria-hidden='true'></i>";
                                break;
                            case 'bateau':
                                color = 'blue';
                                iconHtml = "<i class='fa fa-ship fa-2x' aria-hidden='true'></i>";
                                break;
                            case 'voiture':
                                color = 'yellow';
                                iconHtml = "<i class='fa fa-car fa-2x' aria-hidden='true'></i>";
                                break;
                            case 'bus':
                                color = 'orange';
                                iconHtml = "<i class='fa fa-bus fa-2x' aria-hidden='true'></i>";
                                break;
                            default:
                                color = 'gray';
                                iconHtml = "<i class='fa fa-question fa-2x' aria-hidden='true'></i>";
                        }

                        // Convertit les coordonnées en LatLng
                        const latlngs = coordinates.flat().map(coord => L.latLng(coord[1], coord[0]));

                        // Ajoute une polyline statique pour les trajets déjà effectués
                        if (index > 0) {
                            L.polyline(latlngs, { color: color, weight: 2, opacity: 0.7 }).addTo(map);
                        }

                        // Crée une polyline animée et l'ajoute à la séquence
                        const motionPolyline = L.motion.polyline(
                            latlngs,
                            { color: color, weight: 4 },
                            { easing: L.Motion.Ease.linear },
                            {
                                removeOnEnd: false,
                                icon: L.divIcon({ html: iconHtml, iconSize: L.point(24, 24) })
                            }
                        ).motionDuration(duration);

                        seqGroup.addLayer(motionPolyline);
                    }
                });

                // Ajoute la séquence à la carte
                seqGroup.addTo(map);

                // Fonction pour démarrer l'animation avec des pauses et des zooms
                function startAnimationWithPauses() {
                    let currentIndex = 0;
                    const features = sortedFeatures.filter(f => f.geometry.type === 'MultiLineString');

                    function animateNext() {
                        if (currentIndex >= features.length) return;

                        const feature = features[currentIndex];
                        const coordinates = feature.geometry.coordinates;
                        const latlngs = coordinates.flat().map(coord => L.latLng(coord[1], coord[0]));

                        // Zoom sur le trajet actuel
                        fitBoundsForTrajet(latlngs);

                        // Démarre l'animation après 1 seconde
                        setTimeout(() => {
                            seqGroup.motionStart(currentIndex);
                            currentIndex++;
                            setTimeout(animateNext, 12000); // Attend la fin de l'animation avant de passer au suivant
                        }, 1000);
                    }

                    animateNext();
                }

                // Démarre l'animation au clic
                document.getElementById('startAnimation').addEventListener('click', () => {
                    startAnimationWithPauses();
                });

                // Démarre automatiquement après 1 seconde
                setTimeout(() => {
                    startAnimationWithPauses();
                }, 1000);
            })
            .catch(error => {
                console.error('Erreur de chargement du GeoJSON:', error);
            });
    </script>
</body>
</html>
