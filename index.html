<!DOCTYPE html>
<html>
<head>
    <title>Animation des trajets avec L.Motion</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.motion/dist/leaflet.motion.min.js"></script>
    <style>
        html, body, #map { width: 100%; height: 100%; margin: 0px; padding: 0px; }
        #controls { position: absolute; z-index: 1000; top: 10px; left: 10px; background: white; padding: 10px; border-radius: 5px; }
        select, button { margin-right: 5px; }
        .leaflet-control-zoom { display: none !important; }
        #info-banner {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            text-align: center;
            font-family: Arial, sans-serif;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            min-width: 300px;
        }
        #info-banner .dates { font-size: 16px; margin-bottom: 5px; }
        #info-banner .duration { font-size: 20px; font-weight: bold; margin: 5px 0; }
        #info-banner .distance { font-size: 14px; color: #555; }
        #info-banner .recap { font-size: 16px; font-weight: bold; color: #0066cc; margin-top: 10px; }

        /* --- Ajouts : contrôles et barre de progression en bas --- */
        #bottom-controls {
            position: absolute;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1200;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            pointer-events: auto;
            font-family: Arial, sans-serif;
        }
        #playback-buttons {
            background: rgba(255,255,255,0.95);
            padding: 6px 10px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            display: flex;
            gap: 8px;
            align-items: center;
        }
        #playback-buttons button {
            border: none;
            background: transparent;
            cursor: pointer;
            padding: 6px 8px;
            font-size: 16px;
        }
        #playback-buttons button.active {
            background: rgba(0,102,204,0.12);
            border-radius: 5px;
        }
        #progress-wrapper {
            width: 33%;
            min-width: 220px;
            height: 10px;
            position: relative;
            user-select: none;
        }
        #progress-line {
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 4px;
            background: rgba(0,0,0,0.12);
            border-radius: 3px;
        }
        #progress-dot {
            position: absolute;
            top: 50%;
            left: 0%;
            transform: translate(-50%, -50%);
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #fff;
            border: 3px solid #0066cc;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        #progress-labels {
            margin-top: 6px;
            font-size: 12px;
            color: #333;
            text-align: center;
        }

        /* Responsive */
        @media (max-width: 600px) {
            #progress-wrapper { width: 60%; min-width: 160px; }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="controls">
        <select id="voyageSelect">
            <option value="">-- Choisir un voyage --</option>
        </select>
        <button id="goButton">GO</button>
    </div>
    <div id="info-banner">
        <div class="dates" id="dates"></div>
        <div class="duration" id="duration"></div>
        <div class="distance" id="distance"></div>
        <div class="recap" id="recap"></div>
    </div>

    <!-- Ajout des contrôles en bas -->
    <div id="bottom-controls" aria-hidden="false">
        <div id="playback-buttons" role="group" aria-label="Contrôles de lecture">
            <button id="slowBtn" title="Ralentir">«</button>
            <button id="normalBtn" class="active" title="Vitesse normale">◼︎</button>
            <button id="fastBtn" title="Accélérer">»</button>
            <button id="playPauseBtn" title="Pause / Lecture">⏸</button>
        </div>
        <div id="progress-wrapper" aria-hidden="false">
            <div id="progress-line"></div>
            <div id="progress-dot"></div>
        </div>
        <div id="progress-labels">
            <span id="km-done">0 km</span> • <span id="km-remaining">0 km restants</span>
        </div>
    </div>

<script>
    // Initialisation de la carte
    const map = L.map("map", { zoomControl: false }).setView([48.8566, 2.3522], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Variables globales
    let staticPolylines = [];
    let currentMotionPolyline = null;
    let currentAnimationTimeout = null;

    // --- Variables ajoutées ---
    const ANIM = { slow: 24000, normal: 12000, fast: 6000 };
    let currentAnimDuration = ANIM.normal;
    let isPlaying = true;
    let voyageTotalDistance = 0;
    let kmCompleted = 0;
    let currentSegmentDistance = 0;
    let motionStartTimestamp = null;
    let progressInterval = null;
    let remainingTimeForSegment = null;

    function updateProgressBar() {
        if (!voyageTotalDistance || voyageTotalDistance <= 0) return;
        let progressKm = kmCompleted;
        if (motionStartTimestamp && currentSegmentDistance) {
            const elapsed = Date.now() - motionStartTimestamp;
            const frac = Math.min(1, elapsed / currentAnimDuration);
            progressKm += frac * currentSegmentDistance;
        }
        const percent = Math.min(1, progressKm / voyageTotalDistance);
        document.getElementById('progress-dot').style.left = (percent * 100) + '%';
        document.getElementById('km-done').textContent = `${Math.round(progressKm)} km`;
        document.getElementById('km-remaining').textContent = `${Math.max(0, Math.round(voyageTotalDistance - progressKm))} km restants`;
    }

    // Fonction pour zoomer sur un trajet
    function fitBoundsForTrajet(latlngs) {
        const bounds = L.latLngBounds(latlngs);
        map.fitBounds(bounds, { padding: [50, 50], maxZoom: 12 });
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return `${date.getDate().toString().padStart(2, '0')}/${
            (date.getMonth()+1).toString().padStart(2, '0')}/${date.getFullYear()} ${
            date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
    }

    function getColor(trajet) {
        return { avion: 'red', train: 'green', bateau: 'blue', voiture: 'yellow', bus: 'orange' }[trajet] || 'gray';
    }

    fetch('TRAJETS_ALL_vacances_wgs.geojson')
        .then(r => r.json())
        .then(data => {
            const voyages = [...new Set(data.features.map(f => f.properties.voyage))];
            const select = document.getElementById('voyageSelect');
            voyages.forEach(v => {
                const o = document.createElement('option');
                o.value = v; o.textContent = v;
                select.appendChild(o);
            });

            function startAnimationForVoyage(selectedVoyage) {
                if (currentMotionPolyline) {
                    try { currentMotionPolyline.motionStop(); } catch (e) {}
                    clearTimeout(currentAnimationTimeout);
                    clearInterval(progressInterval);
                }
                map.eachLayer(l => { if (!(l instanceof L.TileLayer)) map.removeLayer(l); });
                staticPolylines = [];

                const voyageFeatures = data.features
                    .filter(f => f.properties.voyage === selectedVoyage && f.geometry.type === 'MultiLineString')
                    .sort((a, b) => a.properties.id - b.properties.id);

                if (!voyageFeatures.length) { alert("Aucun trajet trouvé."); return; }

                const firstDate = new Date(Math.min(...voyageFeatures.map(f => new Date(f.properties.date_deb))));
                const lastDate = new Date(Math.max(...voyageFeatures.map(f => new Date(f.properties.date_fin))));
                voyageTotalDistance = voyageFeatures.reduce((s, f) => s + parseFloat(f.properties.distanceKM), 0);
                kmCompleted = 0;

                let currentIndex = 0;

                function animateCurrentTrajet() {
                    if (currentIndex >= voyageFeatures.length) {
                        document.getElementById('recap').innerHTML =
                            `Voyage du ${formatDate(firstDate)} au ${formatDate(lastDate)}<br>Distance totale : ${Math.round(voyageTotalDistance)} km`;
                        kmCompleted = voyageTotalDistance;
                        updateProgressBar();
                        clearInterval(progressInterval);
                        return;
                    }

                    const f = voyageFeatures[currentIndex];
                    const latlngs = f.geometry.coordinates.flat().map(c => L.latLng(c[1], c[0]));
                    const color = getColor(f.properties.trajet);
                    const iconHtml = getIconHtml(f.properties.trajet);

                    fitBoundsForTrajet(latlngs);

                    if (currentIndex > 0) {
                        const prevF = voyageFeatures[currentIndex-1];
                        const prevLatLngs = prevF.geometry.coordinates.flat().map(c => L.latLng(c[1], c[0]));
                        L.polyline(prevLatLngs, { color: getColor(prevF.properties.trajet), weight: 2, opacity: 0.7 }).addTo(map);
                    }

                    currentSegmentDistance = parseFloat(f.properties.distanceKM) || 0;

                    if (currentMotionPolyline) try { currentMotionPolyline.motionStop(); } catch(e){}
                    clearTimeout(currentAnimationTimeout);

                    currentMotionPolyline = L.motion.polyline(
                        latlngs,
                        { color, weight: 4 },
                        { easing: L.Motion.Ease.linear },
                        { icon: L.divIcon({ html: iconHtml, iconSize: L.point(24,24) }) }
                    ).motionDuration(currentAnimDuration);
                    currentMotionPolyline.addTo(map);

                    document.getElementById('dates').textContent = `${formatDate(f.properties.date_deb)} → ${formatDate(f.properties.date_fin)}`;
                    document.getElementById('duration').textContent = f.properties.duree;
                    document.getElementById('distance').textContent = `${f.properties.distanceKM} km`;
                    document.getElementById('recap').textContent = '';

                    setTimeout(() => {
                        try {
                            currentMotionPolyline.motionStart();
                            motionStartTimestamp = Date.now();
                            clearInterval(progressInterval);
                            progressInterval = setInterval(updateProgressBar, 200);

                            clearTimeout(currentAnimationTimeout);
                            currentAnimationTimeout = setTimeout(() => {
                                try { currentMotionPolyline.motionStop(); } catch(e){}
                                kmCompleted += currentSegmentDistance;
                                currentIndex++;
                                motionStartTimestamp = null;
                                animateCurrentTrajet();
                            }, currentAnimDuration);

                            isPlaying = true;
                            updatePlayPauseUI();
                        } catch(e) { console.error(e); }
                    }, 500);
                }

                animateCurrentTrajet();
            }

            function getIconHtml(trajet) {
                const icons = {
                    avion:"<i class='fa fa-plane fa-2x'></i>",
                    train:"<i class='fa fa-train fa-2x'></i>",
                    bateau:"<i class='fa fa-ship fa-2x'></i>",
                    voiture:"<i class='fa fa-car fa-2x'></i>",
                    bus:"<i class='fa fa-bus fa-2x'></i>"
                };
                return icons[trajet] || "<i class='fa fa-question fa-2x'></i>";
            }

            document.getElementById('goButton').addEventListener('click', () => {
                const v = document.getElementById('voyageSelect').value;
                if (v) startAnimationForVoyage(v);
                else alert("Sélectionnez un voyage.");
            });

            // --- Contrôles Play/Pause/Vitesse ---
            const playPauseBtn = document.getElementById('playPauseBtn');
            const slowBtn = document.getElementById('slowBtn');
            const normalBtn = document.getElementById('normalBtn');
            const fastBtn = document.getElementById('fastBtn');

            function updatePlayPauseUI() {
                playPauseBtn.textContent = isPlaying ? '⏸' : '▶';
            }

            playPauseBtn.addEventListener('click', () => {
                if (!currentMotionPolyline) return;
                if (isPlaying) {
                    currentMotionPolyline.motionPause();
                    const elapsed = Date.now() - motionStartTimestamp;
                    remainingTimeForSegment = Math.max(0, currentAnimDuration - elapsed);
                    clearTimeout(currentAnimationTimeout);
                    clearInterval(progressInterval);
                    isPlaying = false;
                } else {
                    currentMotionPolyline.motionResume();
                    motionStartTimestamp = Date.now() - (currentAnimDuration - remainingTimeForSegment);
                    progressInterval = setInterval(updateProgressBar, 200);
                    currentAnimationTimeout = setTimeout(() => {
                        try { currentMotionPolyline.motionStop(); } catch(e){}
                        kmCompleted += currentSegmentDistance;
                    }, remainingTimeForSegment);
                    isPlaying = true;
                }
                updatePlayPauseUI();
            });

            function changeSpeedTo(newDuration) {
                if (!currentMotionPolyline || !motionStartTimestamp) {
                    currentAnimDuration = newDuration;
                } else {
                    const elapsed = Date.now() - motionStartTimestamp;
                    const frac = Math.min(1, elapsed / currentAnimDuration);
                    currentAnimDuration = newDuration;
                    currentMotionPolyline.motionDuration(newDuration);
                    motionStartTimestamp = Date.now() - frac * newDuration;
                    const remaining = newDuration * (1 - frac);
                    clearTimeout(currentAnimationTimeout);
                    currentAnimationTimeout = setTimeout(() => {
                        try { currentMotionPolyline.motionStop(); } catch(e){}
                        kmCompleted += currentSegmentDistance;
                    }, remaining);
                }
                slowBtn.classList.toggle('active', newDuration === ANIM.slow);
                normalBtn.classList.toggle('active', newDuration === ANIM.normal);
                fastBtn.classList.toggle('active', newDuration === ANIM.fast);
            }

            slowBtn.addEventListener('click', () => changeSpeedTo(ANIM.slow));
            normalBtn.addEventListener('click', () => changeSpeedTo(ANIM.normal));
            fastBtn.addEventListener('click', () => changeSpeedTo(ANIM.fast));
            updatePlayPauseUI();
        });
</script>
</body>
</html>

