<!DOCTYPE html>
<html>
<head>
    <title>Animation des trajets avec L.Motion</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        html, body, #map { width: 100%; height: 100%; margin: 0; padding: 0; }
        #controls { position: absolute; z-index: 1000; top: 10px; left: 10px; background: white; padding: 10px; border-radius: 5px; }
        select, button { margin-right: 5px; }
        .leaflet-control-zoom { display: none !important; }
        #info-banner {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            text-align: center;
            font-family: Arial, sans-serif;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            min-width: 300px;
        }
        #info-banner .dates { font-size: 16px; margin-bottom: 5px; }
        #info-banner .duration { font-size: 20px; font-weight: bold; margin: 5px 0; }
        #info-banner .distance { font-size: 14px; color: #555; }
        #info-banner .recap { font-size: 16px; font-weight: bold; color: #0066cc; margin-top: 10px; }

        /* --- Barre de contrôle en bas --- */
        #bottom-controls {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
        }
        #bottom-controls button {
            background: white;
            border: 1px solid #ccc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* --- Barre de progression --- */
        #progress-container {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 33%;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
            z-index: 1000;
        }
        .progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
        }
        .progress-dot {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            background: black;
            border-radius: 50%;
            z-index: 2;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div id="controls">
        <select id="voyageSelect">
            <option value="">-- Choisir un voyage --</option>
        </select>
        <button id="goButton">GO</button>
    </div>

    <div id="info-banner">
        <div class="dates" id="dates"></div>
        <div class="duration" id="duration"></div>
        <div class="distance" id="distance"></div>
        <div class="recap" id="recap"></div>
    </div>

    <div id="bottom-controls">
        <button id="slower"><i class="fa fa-minus"></i></button>
        <button id="playPause"><i class="fa fa-play"></i></button>
        <button id="faster"><i class="fa fa-plus"></i></button>
    </div>

    <div id="progress-container">
        <div class="progress-bar"></div>
        <div class="progress-dot" id="progress-dot"></div>
    </div>

    <script>
        const map = L.map("map", { zoomControl: false }).setView([48.8566, 2.3522], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        }

        function getColor(trajet) {
            const colors = { avion:'red', train:'green', bateau:'blue', voiture:'yellow', bus:'orange' };
            return colors[trajet] || 'gray';
        }

        function getIconHtml(trajet) {
            const icons = {
                avion:"<i class='fa fa-plane fa-2x'></i>",
                train:"<i class='fa fa-train fa-2x'></i>",
                bateau:"<i class='fa fa-ship fa-2x'></i>",
                voiture:"<i class='fa fa-car fa-2x'></i>",
                bus:"<i class='fa fa-bus fa-2x'></i>"
            };
            return icons[trajet] || "<i class='fa fa-question fa-2x'></i>";
        }

        fetch('TRAJETS_ALL_vacances_wgs.geojson')
            .then(r => r.json())
            .then(data => {
                const voyages = [...new Set(data.features.map(f => f.properties.voyage))];
                const select = document.getElementById('voyageSelect');
                voyages.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v; opt.textContent = v;
                    select.appendChild(opt);
                });

                let currentIndex = 0;
                let kmCompleted = 0;
                let totalDistance = 0;
                let currentLine = null;
                let rafId = null;
                let isPlaying = false;
                let speedFactor = 1;
                let voyageFeatures = [];
                let firstDate, lastDate;

                const progressDot = document.getElementById('progress-dot');

                function fitBoundsForTrajet(latlngs) {
                    const bounds = L.latLngBounds(latlngs);
                    map.fitBounds(bounds, { padding: [50, 50], maxZoom: 12 });
                }

                function buildProgressBarGradient(features) {
                    let current = 0;
                    const stops = features.map(f => {
                        const dist = parseFloat(f.properties.distanceKM);
                        const color = getColor(f.properties.trajet);
                        const start = (current / totalDistance) * 100;
                        current += dist;
                        const end = (current / totalDistance) * 100;
                        return { color, start, end };
                    });
                    const gradient = stops.map(s => `${s.color} ${s.start}%, ${s.color} ${s.end}%`).join(', ');
                    document.querySelector('.progress-bar').style.background = `linear-gradient(to right, ${gradient})`;
                }

                function animateCurrentTrajet() {
                    if (currentIndex >= voyageFeatures.length) {
                        isPlaying = false;
                        document.getElementById('recap').innerHTML =
                            `Voyage du ${formatDate(firstDate)} au ${formatDate(lastDate)}<br>` +
                            `Distance totale : ${Math.round(totalDistance)} km`;
                        return;
                    }

                    const feature = voyageFeatures[currentIndex];
                    const latlngs = feature.geometry.coordinates.flat().map(c => L.latLng(c[1], c[0]));
                    const color = getColor(feature.properties.trajet);
                    const iconHtml = getIconHtml(feature.properties.trajet);
                    fitBoundsForTrajet(latlngs);

                    if (currentLine) map.removeLayer(currentLine);

                    currentLine = L.polyline([latlngs[0]], { color, weight: 4 }).addTo(map);
                    const marker = L.marker(latlngs[0], { icon: L.divIcon({ html: iconHtml, iconSize: L.point(24,24) }) }).addTo(map);

                    const duration = 12000 / speedFactor;
                    const distKM = parseFloat(feature.properties.distanceKM);

                    document.getElementById('dates').textContent = `${formatDate(feature.properties.date_deb)} → ${formatDate(feature.properties.date_fin)}`;
                    document.getElementById('duration').textContent = feature.properties.duree;
                    document.getElementById('distance').textContent = `${distKM} km`;
                    document.getElementById('recap').textContent = '';

                    let startTime = null;

                    function step(ts) {
                        if (!startTime) startTime = ts;
                        if (!isPlaying) {
                            rafId = requestAnimationFrame(step);
                            return;
                        }
                        const elapsed = (ts - startTime) * speedFactor;
                        const progress = Math.min(elapsed / duration, 1);
                        const idx = Math.floor(progress * (latlngs.length - 1));
                        currentLine.setLatLngs(latlngs.slice(0, idx+1));
                        marker.setLatLng(latlngs[idx]);
                        const traveled = kmCompleted + distKM * progress;
                        const pct = (traveled / totalDistance) * 100;
                        progressDot.style.left = pct + '%';

                        if (progress < 1) {
                            rafId = requestAnimationFrame(step);
                        } else {
                            kmCompleted += distKM;
                            currentIndex++;
                            animateCurrentTrajet();
                        }
                    }
                    rafId = requestAnimationFrame(step);
                }

                document.getElementById('goButton').addEventListener('click', () => {
                    const selected = select.value;
                    if (!selected) return alert('Veuillez sélectionner un voyage.');
                    map.eachLayer(l => { if (!(l instanceof L.TileLayer)) map.removeLayer(l); });
                    currentIndex = 0; kmCompleted = 0; isPlaying = true;
                    voyageFeatures = data.features.filter(f => f.properties.voyage === selected && f.geometry.type === 'MultiLineString')
                        .sort((a,b)=>a.properties.id-b.properties.id);
                    totalDistance = voyageFeatures.reduce((s,f)=>s+parseFloat(f.properties.distanceKM),0);
                    firstDate = new Date(Math.min(...voyageFeatures.map(f => new Date(f.properties.date_deb))));
                    lastDate = new Date(Math.max(...voyageFeatures.map(f => new Date(f.properties.date_fin))));
                    buildProgressBarGradient(voyageFeatures);
                    animateCurrentTrajet();
                });

                document.getElementById('playPause').addEventListener('click', () => {
                    isPlaying = !isPlaying;
                    document.getElementById('playPause').innerHTML = isPlaying ? "<i class='fa fa-pause'></i>" : "<i class='fa fa-play'></i>";
                });
                document.getElementById('slower').addEventListener('click', () => speedFactor = Math.max(0.5, speedFactor - 0.5));
                document.getElementById('faster').addEventListener('click', () => speedFactor = Math.min(5, speedFactor + 0.5));
            });
    </script>
</body>
</html>
