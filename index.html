<!DOCTYPE html>
<html>
<head>
    <title>Animation des trajets avec L.Motion</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.motion/dist/leaflet.motion.min.js"></script>
    <style>
        html, body, #map { width: 100%; height: 100%; margin: 0px; padding: 0px; }
        #controls { position: absolute; z-index: 1000; top: 10px; left: 10px; background: white; padding: 10px; border-radius: 5px; }
        select, button { margin-right: 5px; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="controls">
        <select id="voyageSelect">
            <option value="">-- Choisir un voyage --</option>
        </select>
        <button id="goButton">GO</button>
    </div>
    <script>
        // Initialisation de la carte
        const map = L.map("map").setView([48.8566, 2.3522], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Fonction pour zoomer sur un trajet
        function fitBoundsForTrajet(latlngs) {
            const bounds = L.latLngBounds(latlngs);
            map.fitBounds(bounds, { padding: [50, 50], maxZoom: 12 });
        }

        // Stocke les polylines statiques (pour les trajets déjà effectués)
        let staticPolylines = [];

        // Chargement du GeoJSON
        fetch('TRAJETS_ALL_vacances_wgs.geojson')
            .then(response => response.json())
            .then(data => {
                // Remplit la liste déroulante avec les valeurs uniques de "voyage"
                const voyages = [...new Set(data.features.map(feature => feature.properties.voyage))];
                const select = document.getElementById('voyageSelect');
                voyages.forEach(voyage => {
                    const option = document.createElement('option');
                    option.value = voyage;
                    option.textContent = voyage;
                    select.appendChild(option);
                });

                // Fonction pour démarrer l'animation pour un voyage sélectionné
                function startAnimationForVoyage(selectedVoyage) {
                    // Efface les polylines statiques précédentes
                    staticPolylines.forEach(polyline => map.removeLayer(polyline));
                    staticPolylines = [];

                    // Filtre les features par voyage sélectionné
                    const voyageFeatures = data.features
                        .filter(feature => feature.properties.voyage === selectedVoyage && feature.geometry.type === 'MultiLineString')
                        .sort((a, b) => a.properties.id - b.properties.id);

                    if (voyageFeatures.length === 0) {
                        alert("Aucun trajet trouvé pour ce voyage.");
                        return;
                    }

                    let currentIndex = 0;

                    function animateNext() {
                        if (currentIndex >= voyageFeatures.length) return;

                        const feature = voyageFeatures[currentIndex];
                        const coordinates = feature.geometry.coordinates;
                        const trajet = feature.properties.trajet;
                        let color, iconHtml, duration = 12000;

                        // Définit la couleur et l'icône selon le type de trajet
                        switch (trajet) {
                            case 'avion':
                                color = 'red';
                                iconHtml = "<i class='fa fa-plane fa-2x' aria-hidden='true'></i>";
                                break;
                            case 'train':
                                color = 'green';
                                iconHtml = "<i class='fa fa-train fa-2x' aria-hidden='true'></i>";
                                break;
                            case 'bateau':
                                color = 'blue';
                                iconHtml = "<i class='fa fa-ship fa-2x' aria-hidden='true'></i>";
                                break;
                            case 'voiture':
                                color = 'yellow';
                                iconHtml = "<i class='fa fa-car fa-2x' aria-hidden='true'></i>";
                                break;
                            case 'bus':
                                color = 'orange';
                                iconHtml = "<i class='fa fa-bus fa-2x' aria-hidden='true'></i>";
                                break;
                            default:
                                color = 'gray';
                                iconHtml = "<i class='fa fa-question fa-2x' aria-hidden='true'></i>";
                        }

                        // Convertit les coordonnées en LatLng
                        const latlngs = coordinates.flat().map(coord => L.latLng(coord[1], coord[0]));

                        // Zoom sur le trajet actuel
                        fitBoundsForTrajet(latlngs);

                        // Ajoute une polyline statique fine pour les trajets précédents
                        if (currentIndex > 0) {
                            const previousFeature = voyageFeatures[currentIndex - 1];
                            const previousCoords = previousFeature.geometry.coordinates;
                            const previousLatLngs = previousCoords.flat().map(coord => L.latLng(coord[1], coord[0]));
                            const previousPolyline = L.polyline(previousLatLngs, { color: getColor(previousFeature.properties.trajet), weight: 2, opacity: 0.7 });
                            staticPolylines.push(previousPolyline);
                            previousPolyline.addTo(map);
                        }

                        // Crée une polyline animée pour le trajet actuel (épaisse)
                        const motionPolyline = L.motion.polyline(
                            latlngs,
                            { color: color, weight: 4 },
                            { easing: L.Motion.Ease.linear },
                            {
                                removeOnEnd: false,
                                icon: L.divIcon({ html: iconHtml, iconSize: L.point(24, 24) })
                            }
                        ).motionDuration(duration);

                        // Ajoute la polyline animée à la carte
                        motionPolyline.addTo(map);

                        // Démarre l'animation après un court délai pour le zoom
                        setTimeout(() => {
                            motionPolyline.motionStart();
                        }, 500); // Délai court pour le zoom

                        // Passe au trajet suivant après la fin de l'animation
                        setTimeout(() => {
                            currentIndex++;
                            animateNext();
                        }, duration);
                    }

                    animateNext();
                }

                // Fonction pour obtenir la couleur selon le type de trajet
                function getColor(trajet) {
                    switch (trajet) {
                        case 'avion': return 'red';
                        case 'train': return 'green';
                        case 'bateau': return 'blue';
                        case 'voiture': return 'yellow';
                        case 'bus': return 'orange';
                        default: return 'gray';
                    }
                }

                // Écouteur d'événement pour le bouton "GO"
                document.getElementById('goButton').addEventListener('click', () => {
                    const selectedVoyage = document.getElementById('voyageSelect').value;
                    if (selectedVoyage) {
                        startAnimationForVoyage(selectedVoyage);
                    } else {
                        alert("Veuillez sélectionner un voyage.");
                    }
                });
            })
            .catch(error => {
                console.error('Erreur de chargement du GeoJSON:', error);
            });
    </script>
</body>
</html>
