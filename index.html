<!DOCTYPE html>
<html>
<head>
    <title>Affichage et Animation des Trajets</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        #map { height: 600px; margin-bottom: 10px; }
        button { margin: 5px; padding: 8px 12px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="map"></div>
    <button id="animateAll">Animer tous les trajets</button>

    <script>
        // Initialisation de la carte avec OSM
        const map = L.map('map').setView([30, 105], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Couleurs par type de transport
        const colorByTrajet = {
            'avion': '#FF0000',
            'train': '#00FF00',
            'bateau': '#0000FF',
        };

        // Variable pour stocker les polylines des trajets
        let polylines = [];

        // Chargement du GeoJSON externe
        fetch('TRAJETS_ALL_vacances_wgs.geojson')
            .then(response => response.json())
            .then(data => {
                console.log("GeoJSON chargé:", data);

                // Afficher tous les trajets
                data.features.forEach(feature => {
                    if (feature.geometry.type === 'LineString') {
                        const latlngs = feature.geometry.coordinates.map(coord => L.latLng(coord[1], coord[0]));
                        const color = colorByTrajet[feature.properties.trajet] || '#808080';
                        const polyline = L.polyline(latlngs, { color: color, weight: 3 }).addTo(map);
                        polylines.push({ id: feature.properties.id, polyline: polyline, latlngs: latlngs });
                    }
                });

                // Trier les polylines par ID
                polylines.sort((a, b) => a.id - b.id);

                // Bouton pour animer tous les trajets
                document.getElementById('animateAll').addEventListener('click', () => {
                    if (polylines.length === 0) {
                        alert("Aucun trajet n'est disponible.");
                        return;
                    }

                    // Animer chaque trajet dans l'ordre des IDs
                    polylines.forEach((item, index) => {
                        setTimeout(() => {
                            animatePolyline(item.polyline, item.latlngs);
                        }, index * 5000); // Délai entre chaque trajet
                    });
                });
            })
            .catch(error => console.error("Erreur de chargement du GeoJSON:", error));

        // Fonction pour animer une polyline
        function animatePolyline(polyline, latlngs) {
            polyline.setLatLngs([latlngs[0]]);

            let startTime;
            const duration = 5000; // Durée de l'animation en ms

            function animate(currentTime) {
                if (!startTime) startTime = currentTime;
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);

                const numPoints = Math.floor(progress * (latlngs.length - 1)) + 1;
                const partialProgress = (progress * (latlngs.length - 1)) % 1;

                const points = latlngs.slice(0, numPoints);
                if (numPoints < latlngs.length) {
                    const startPoint = latlngs[numPoints - 1];
                    const endPoint = latlngs[numPoints];
                    const interpolatedPoint = L.latLng(
                        startPoint.lat + (endPoint.lat - startPoint.lat) * partialProgress,
                        startPoint.lng + (endPoint.lng - startPoint.lng) * partialProgress
                    );
                    points.push(interpolatedPoint);
                }

                polyline.setLatLngs(points);

                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            }

            requestAnimationFrame(animate);
        }
    </script>
</body>
</html>
