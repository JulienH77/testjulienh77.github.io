<!DOCTYPE html>
<html>
<head>
    <title>Animation des trajets avec L.Motion</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.motion/dist/leaflet.motion.min.js"></script>
    <style>
        html, body, #map { width: 100%; height: 100%; margin: 0px; padding: 0px; }
        #controls { position: absolute; z-index: 1000; top: 10px; left: 10px; background: white; padding: 10px; border-radius: 5px; }
        select, button { margin-right: 5px; }
        .leaflet-control-zoom { display: none !important; }
        #info-banner {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            text-align: center;
            font-family: Arial, sans-serif;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            min-width: 300px;
        }
        #info-banner .dates {
            font-size: 16px;
            margin-bottom: 5px;
        }
        #info-banner .duration {
            font-size: 20px;
            font-weight: bold;
            margin: 5px 0;
        }
        #info-banner .distance {
            font-size: 14px;
            color: #555;
        }
        #info-banner .recap {
            font-size: 16px;
            font-weight: bold;
            color: #0066cc;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="controls">
        <select id="voyageSelect">
            <option value="">-- Choisir un voyage --</option>
        </select>
        <button id="goButton">GO</button>
    </div>
    <div id="info-banner">
        <div class="dates" id="dates"></div>
        <div class="duration" id="duration"></div>
        <div class="distance" id="distance"></div>
        <div class="recap" id="recap"></div>
    </div>
    <script>
        // Initialisation de la carte
        const map = L.map("map", {
            zoomControl: false
        }).setView([48.8566, 2.3522], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Fonction pour zoomer sur un trajet
        function fitBoundsForTrajet(latlngs) {
            const bounds = L.latLngBounds(latlngs);
            map.fitBounds(bounds, { padding: [50, 50], maxZoom: 12 });
        }

        // Stocke les polylines statiques (pour les trajets déjà effectués)
        let staticPolylines = [];
        let currentAnimationGroup = null;

        // Fonction pour formater une date (ex: "2025-05-15T09:55:00.874" -> "15/05/2025 09:55")
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }

        // Chargement du GeoJSON
        fetch('TRAJETS_ALL_vacances_wgs.geojson')
            .then(response => response.json())
            .then(data => {
                // Remplit la liste déroulante avec les valeurs uniques de "voyage"
                const voyages = [...new Set(data.features.map(feature => feature.properties.voyage))];
                const select = document.getElementById('voyageSelect');
                voyages.forEach(voyage => {
                    const option = document.createElement('option');
                    option.value = voyage;
                    option.textContent = voyage;
                    select.appendChild(option);
                });

                // Fonction pour obtenir la couleur selon le type de trajet
                function getColor(trajet) {
                    switch (trajet) {
                        case 'avion': return 'red';
                        case 'train': return 'green';
                        case 'bateau': return 'blue';
                        case 'voiture': return 'yellow';
                        case 'bus': return 'orange';
                        default: return 'gray';
                    }
                }

                // Fonction pour démarrer l'animation pour un voyage sélectionné
                function startAnimationForVoyage(selectedVoyage) {
                    // Arrête toute animation en cours
                    if (currentAnimationGroup) {
                        currentAnimationGroup.motionStop();
                        currentAnimationGroup = null;
                    }

                    // Efface toutes les couches de la carte (sauf la couche de tuiles)
                    map.eachLayer(layer => {
                        if (!(layer instanceof L.TileLayer)) {
                            map.removeLayer(layer);
                        }
                    });
                    staticPolylines = [];

                    // Filtre les features par voyage sélectionné
                    const voyageFeatures = data.features
                        .filter(feature => feature.properties.voyage === selectedVoyage && feature.geometry.type === 'MultiLineString')
                        .sort((a, b) => a.properties.id - b.properties.id);

                    if (voyageFeatures.length === 0) {
                        alert("Aucun trajet trouvé pour ce voyage.");
                        return;
                    }

                    // Calcule les infos globales du groupe
                    const firstDate = new Date(Math.min(...voyageFeatures.map(f => new Date(f.properties.date_deb))));
                    const lastDate = new Date(Math.max(...voyageFeatures.map(f => new Date(f.properties.date_fin))));
                    const totalDistance = voyageFeatures.reduce((sum, f) => sum + parseFloat(f.properties.distanceKM), 0);

                    // Variable pour suivre l'index actuel
                    let currentIndex = 0;

                    // Fonction pour animer le trajet courant
                    function animateCurrentTrajet() {
                        if (currentIndex >= voyageFeatures.length) {
                            // Tous les tronçons sont terminés, affiche les stats finales
                            document.getElementById('dates').textContent = '';
                            document.getElementById('duration').textContent = '';
                            document.getElementById('distance').textContent = '';
                            document.getElementById('recap').innerHTML =
                                `Voyage du ${formatDate(firstDate)} au ${formatDate(lastDate)}<br>Distance totale : ${Math.round(totalDistance)} km`;
                            return;
                        }

                        const feature = voyageFeatures[currentIndex];
                        const coordinates = feature.geometry.coordinates;
                        const trajet = feature.properties.trajet;
                        const color = getColor(trajet);
                        let iconHtml, duration = 12000;

                        // Définit l'icône selon le type de trajet
                        switch (trajet) {
                            case 'avion':
                                iconHtml = "<i class='fa fa-plane fa-2x' aria-hidden='true'></i>";
                                break;
                            case 'train':
                                iconHtml = "<i class='fa fa-train fa-2x' aria-hidden='true'></i>";
                                break;
                            case 'bateau':
                                iconHtml = "<i class='fa fa-ship fa-2x' aria-hidden='true'></i>";
                                break;
                            case 'voiture':
                                iconHtml = "<i class='fa fa-car fa-2x' aria-hidden='true'></i>";
                                break;
                            case 'bus':
                                iconHtml = "<i class='fa fa-bus fa-2x' aria-hidden='true'></i>";
                                break;
                            default:
                                iconHtml = "<i class='fa fa-question fa-2x' aria-hidden='true'></i>";
                        }

                        // Convertit les coordonnées en LatLng
                        const latlngs = coordinates.flat().map(coord => L.latLng(coord[1], coord[0]));

                        // Zoom sur le trajet actuel
                        fitBoundsForTrajet(latlngs);

                        // Ajoute une polyline statique fine pour les trajets précédents
                        if (currentIndex > 0) {
                            const previousFeature = voyageFeatures[currentIndex - 1];
                            const previousCoords = previousFeature.geometry.coordinates;
                            const previousLatLngs = previousCoords.flat().map(coord => L.latLng(coord[1], coord[0]));
                            const previousPolyline = L.polyline(previousLatLngs, { color: getColor(previousFeature.properties.trajet), weight: 2, opacity: 0.7 });
                            staticPolylines.push(previousPolyline);
                            previousPolyline.addTo(map);
                        }

                        // Crée une polyline animée pour le trajet actuel (épaisse)
                        const motionPolyline = L.motion.polyline(
                            latlngs,
                            { color: color, weight: 4 },
                            { easing: L.Motion.Ease.linear },
                            {
                                removeOnEnd: false,
                                icon: L.divIcon({ html: iconHtml, iconSize: L.point(24, 24) })
                            }
                        ).motionDuration(duration);

                        // Ajoute la polyline animée à la carte
                        motionPolyline.addTo(map);

                        // Met à jour le bandeau d'informations pour ce trajet
                        document.getElementById('dates').textContent =
                            `${formatDate(feature.properties.date_deb)} → ${formatDate(feature.properties.date_fin)}`;
                        document.getElementById('duration').textContent = feature.properties.duree;
                        document.getElementById('distance').textContent = `${feature.properties.distanceKM} km`;
                        document.getElementById('recap').textContent = '';

                        // Démarre l'animation après un court délai pour le zoom
                        setTimeout(() => {
                            motionPolyline.motionStart();
                        }, 500);

                        // Passe au trajet suivant après la fin de l'animation
                        setTimeout(() => {
                            currentIndex++;
                            animateCurrentTrajet();
                        }, duration);
                    }

                    // Démarre l'animation du premier trajet
                    animateCurrentTrajet();
                }

                // Écouteur d'événement pour le bouton "GO"
                document.getElementById('goButton').addEventListener('click', () => {
                    const selectedVoyage = document.getElementById('voyageSelect').value;
                    if (selectedVoyage) {
                        startAnimationForVoyage(selectedVoyage);
                    } else {
                        alert("Veuillez sélectionner un voyage.");
                    }
                });
            })
            .catch(error => {
                console.error('Erreur de chargement du GeoJSON:', error);
            });
    </script>
</body>
</html>
